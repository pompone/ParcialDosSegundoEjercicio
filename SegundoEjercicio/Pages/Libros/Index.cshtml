@page
@model SegundoEjercicio.Pages.Libros.IndexModel
@{
    ViewData["Title"] = "Libros";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Libros</h2>
    <div class="d-flex gap-2">
        @* Solo Bibliotecario ve estas acciones superiores *@
        @if (User.IsInRole("Bibliotecario"))
        {
            <a class="btn btn-outline-secondary" asp-page="/Libros/Prestamos/Index">Préstamos</a>
            <a class="btn btn-success" asp-page="Create">Nuevo libro</a>
        }
    </div>
</div>

<form method="get" class="row row-cols-lg-auto g-3 align-items-center mb-3">
    <div class="col-12">
        <input asp-for="Q" class="form-control" placeholder="Buscar por título, autor, categoría o ISBN" />
    </div>
    <div class="col-12">
        <select asp-for="CategoryId" asp-items="Model.Categories" class="form-select">
            <option value="">-- Todas las categorías --</option>
        </select>
    </div>
    <div class="col-12">
        <button class="btn btn-outline-primary">Buscar</button>
    </div>
</form>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Título</th>
            <th>Autor</th>
            <th>Categoría</th>
            <th>Año</th>
            <th>ISBN</th>
            <th>Disp.</th>
            <th class="text-end">Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var b in Model.Books)
        {
            <tr>
                <td>@b.Title</td>
                <td>@b.Author?.Name</td>
                <td>@b.Category?.Name</td>
                <td>@b.PublishedYear</td>
                <td>@b.ISBN</td>
                <td>@b.CopiesAvailable</td>
                <td class="text-end">
                    @* --- Acciones para BIBLIOTECARIO --- *@
                    @if (User.IsInRole("Bibliotecario"))
                    {
                        <a class="btn btn-sm btn-outline-secondary"
                           asp-page="Edit" asp-route-id="@b.Id">Editar</a>

                        <a class="btn btn-sm btn-outline-danger ms-2"
                           asp-page="Delete" asp-route-id="@b.Id">Borrar</a>

                        @if (b.CopiesAvailable > 0)
                        {
                            <a class="btn btn-sm btn-outline-success ms-2"
                               asp-page="/Libros/Prestamos/Create" asp-route-bookId="@b.Id">
                                Prestar
                            </a>
                        }
                        else
                        {
                            <button class="btn btn-sm btn-outline-secondary ms-2" disabled>
                                Sin stock
                            </button>
                        }
                    }
                    @* --- Acciones para SOCIO --- *@
                    else if (User.IsInRole("Socio"))
                    {
                        @if (b.CopiesAvailable > 0)
                        {
                            <a class="btn btn-sm btn-outline-primary"
                               asp-page="/Libros/Solicitudes/Create" asp-route-bookId="@b.Id">
                                Solicitar préstamo
                            </a>
                        }
                        else
                        {
                            <button class="btn btn-sm btn-outline-secondary" disabled title="Sin ejemplares disponibles">
                                Solicitar préstamo
                            </button>
                        }
                    }
                    @* --- Usuario logueado sin rol válido, o visitante --- *@
                    else
                    {
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            <span class="badge bg-light text-dark">Sin permisos</span>
                        }
                        else
                        {
                            <a class="btn btn-sm btn-outline-primary"
                               asp-area="Identity" asp-page="/Account/Login">
                                Iniciar sesión
                            </a>
                        }
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

@if (!Model.Books.Any())
{
    <div class="alert alert-info mb-0">No hay resultados.</div>
}
